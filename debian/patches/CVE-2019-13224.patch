From: Markus Koschany <apo@debian.org>
Date: Wed, 17 Jul 2019 14:54:36 +0200
Subject: CVE-2019-13224

Instead of using the upstream patch from
https://github.com/kkos/oniguruma/commit/0f7f61ed1b7b697e283e37bd2d731d0bd57adb55

we use the idea of Fedora's maintainer and check for the existence of r when
freeing cpat to avoid a use-after-free. This will reduce the risk of breaking
existing systems that rely on the current behavior.

Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=931878
Origin: https://src.fedoraproject.org/rpms/oniguruma/blob/8ebd53c39d2e8283f10ce8139dfef657c3f7c79f/f/0101-onig_new_deluxe-don-t-free-new-pattern-if-success.patch

---
 regext.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/regext.c b/regext.c
index b1b957b..0d0d6ef 100644
--- a/regext.c
+++ b/regext.c
@@ -196,7 +196,7 @@ onig_new_deluxe(regex_t** reg, const UChar* pattern, const UChar* pattern_end,
   }
 
  err2:
-  if (cpat != pattern) xfree(cpat);
+  if (r && (cpat != pattern)) xfree(cpat);
 
   return r;
 }
